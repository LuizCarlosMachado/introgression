# Introgression Detection Pipeline using ARGweaverD

## Overview
This pipeline processes ARG inference results to identify introgressed regions based on inferred migration events. The main steps include:

1. Creating the `mig_file.txt`.
2. Generating the `hapmig.txt`.
3. Converting ARGs to BED format.
4. Summarizing migration regions.

## Files Used

- **`intro_tracts_sim_SP_B2A_1mb.log`**: Execution log file for ARG inference.
- **`intro_tracts_sim_SP_B2A_1mb.masked_regions.bed`**: File containing masked regions.
- **`intro_tracts_sim_SP_B2A_1mb.stats`**: Execution statistics.
- **`mig_file.txt`**: Defines migration events for summarization.
- **`hapmig.txt`**: Lists migrating haplotypes for individualized statistics.
- **`.smc.gz` files**: Contain inferred ARGs and are used for BED conversion.

## 3. Structure of `mig_file.txt`

Format:
```
<B2A_mig>  <recipient_pop>  <source_pop>  <time>
```
Example:
```
B2A_mig  1  0  1129.5
```
- **B2A_mig**: Name of the migration event.
- **1**: Recipient population.
- **0**: Source population.
- **1129.5**: Time in generations.

## 4. Generating `hapmig.txt`

The `hapmig.txt` file is automatically generated by a script that extracts haplotypes from `.smc` and associates them with migration events.

Format:
```
<B2A_mig_hap>	<recipient_pop>	<source_pop>	<time>	<haplotype>
```
Example:
```
B2A_mig_A_1_2  1  0  1000  A_1_2
```

## 5. Conversion to BED and Summarization

Two main steps:
1. **Convert ARGs to BED format**:
   ```bash
   smc2bed-all ${RUNAME}/${RUNAME}
   ```
2. **Summarize migration events**:
   ```bash
   arg-summarize --log-file ${RUNAME}/${RUNAME}.log \
                 -a ${RUNAME}/${RUNAME}.bed.gz \
                 --burnin 500 \
                 -r ${CHR}:${WINSTART}-${WINEND} \
                 --mean \
                 --hap-mig-file $HAPMIGF | bgzip > ${OUTPREF}.migStatsHap.bed.gz
   ```

## 6. Automated Scripts

### `generate_hapmig.py`
This script creates the `hapmig.txt`:

```python
haplotypes_smc = ["A_1_2", "B_1_1", "C_0_2", "A_2_2", ...]
event_base = "B2A_mig"
recipient_pop = 1
source_pop = 0
migration_time = 1000

new_hap_mig_file = [f"{event_base}_{hap}\t{recipient_pop}\t{source_pop}\t{migration_time}\t{hap}" for hap in haplotypes_smc]

with open("outputs/intro_tracts_sim_SP_B2A_1mb_hapmig.txt", "w") as f:
    f.write("\n".join(new_hap_mig_file) + "\n")
```

### `run_arg_processing.sh`
Script to execute the final steps:

```bash
#!/bin/bash

RUNAME=$1
CHR=$2
WINSTART=$3
WINEND=$4
HAPMIGF=$5
OUTPREF=$6

smc2bed-all ${RUNAME}/${RUNAME}
arg-summarize --log-file ${RUNAME}/${RUNAME}.log \
              -a ${RUNAME}/${RUNAME}.bed.gz \
              --burnin 500 \
              -r ${CHR}:${WINSTART}-${WINEND} \
              --mean \
              --hap-mig-file $HAPMIGF | bgzip > ${OUTPREF}.migStatsHap.bed.gz
```

## 7. Final Considerations
- **Adjusting migration parameters**: If necessary, migration times in `hapmig.txt` and `mig_file.txt` should be adjusted according to inference results.
- **Additional Parameters**: Using `--max-migs` and `--start-mig` may affect convergence and should be tested if improper MCMC mixing occurs.

This pipeline automates the identification and analysis of introgressed regions based on inferred ARGs.


